import{_ as i,o as a,c as e,ag as t}from"./chunks/framework.DEqXEGcv.js";const c=JSON.parse('{"title":"Memory Management","description":"","frontmatter":{},"headers":[],"relativePath":"memory.md","filePath":"memory.md","lastUpdated":1772228606000}'),n={name:"memory.md"};function l(h,s,p,k,r,d){return a(),e("div",null,[...s[0]||(s[0]=[t(`<h1 id="memory-management" tabindex="-1">Memory Management <a class="header-anchor" href="#memory-management" aria-label="Permalink to &quot;Memory Management&quot;">​</a></h1><p>MCPConnect handles memory automatically in most cases: objects returned by tool and resource methods are serialized and then freed by the framework once the response has been sent. However, there are scenarios where this is not enough.</p><h2 id="when-automatic-management-falls-short" tabindex="-1">When Automatic Management Falls Short <a class="header-anchor" href="#when-automatic-management-falls-short" aria-label="Permalink to &quot;When Automatic Management Falls Short&quot;">​</a></h2><h3 id="dependent-objects" tabindex="-1">Dependent objects <a class="header-anchor" href="#dependent-objects" aria-label="Permalink to &quot;Dependent objects&quot;">​</a></h3><p>MCPConnect owns and frees the object you return. But if that object in turn owns — or depends on — other objects that were created alongside it, you need to ensure those are freed too.</p><p>In a <code>TObjectList&lt;T&gt;</code> with default ownership this is not a problem because the list frees its children. But in more complex graphs where ownership is ambiguous or where cleanup requires closing handles or releasing external resources, you need explicit control.</p><h3 id="exception-safety" tabindex="-1">Exception safety <a class="header-anchor" href="#exception-safety" aria-label="Permalink to &quot;Exception safety&quot;">​</a></h3><p>If an exception is raised after you create the return object but before the method exits, the object leaks because MCPConnect never receives it. The classic guard is a <code>try/except</code> block:</p><div class="language-pascal vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">pascal</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TDelphiDayTool.GetTickets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: TTickets;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> := TTickets.Create;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TTicket.Create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Conferenza + Seminari&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, StrToDate(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;19/11/2025&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">179.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TTicket.Create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Solo Conferenza&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, StrToDate(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;19/11/2025&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TTicket.Create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Young ticket&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, StrToDate(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;19/11/2025&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">69.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  except</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.Free;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    raise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>This works but adds boilerplate. The <code>IGarbageCollector</code> offers a cleaner alternative.</p><h2 id="igarbagecollector" tabindex="-1">IGarbageCollector <a class="header-anchor" href="#igarbagecollector" aria-label="Permalink to &quot;IGarbageCollector&quot;">​</a></h2><p><code>IGarbageCollector</code> is a request-scoped collector that frees everything registered in it at the end of the request, whether it completes normally or raises an exception. Inject it into your tool or resource class via the <code>[Context]</code> attribute:</p><div class="language-pascal vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">pascal</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uses</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  MCPConnect.Core.Utils;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TDelphiDayTool = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [Context] FGC: IGarbageCollector;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [McpTool(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;get_tickets&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Get available tickets&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GetTickets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: TTickets;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>MCPConnect creates and injects a <code>IGarbageCollector</code> instance for each request. It is destroyed — and all registered objects freed — when the request ends.</p><h3 id="exception-safe-object-creation" tabindex="-1">Exception-safe object creation <a class="header-anchor" href="#exception-safe-object-creation" aria-label="Permalink to &quot;Exception-safe object creation&quot;">​</a></h3><p>Register the object immediately after creating it. If an exception is raised later, the GC disposes it:</p><div class="language-pascal vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">pascal</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TDelphiDayTool.GetTickets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: TTickets;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> := TTickets.Create;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  FGC.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// GC will free Result if an exception is raised before return</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TTicket.Create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Conferenza + Seminari&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, StrToDate(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;19/11/2025&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">179.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TTicket.Create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Solo Conferenza&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, StrToDate(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;19/11/2025&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TTicket.Create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Young ticket&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, StrToDate(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;19/11/2025&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">69.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>No <code>try/except</code> needed: the GC acts as the safety net.</p><h3 id="custom-disposal-action" tabindex="-1">Custom disposal action <a class="header-anchor" href="#custom-disposal-action" aria-label="Permalink to &quot;Custom disposal action&quot;">​</a></h3><p>For objects that require special cleanup beyond <code>Free</code>, pass a disposal procedure:</p><div class="language-pascal vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">pascal</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FGC.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LConnection, procedure</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  LConnection.Close;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  LConnection.Free;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h2 id="igarbagecollector-api-reference" tabindex="-1">IGarbageCollector API Reference <a class="header-anchor" href="#igarbagecollector-api-reference" aria-label="Permalink to &quot;IGarbageCollector API Reference&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>Add(obj)</code></td><td>Track a single object; freed with <code>obj.Free</code> at end of request</td></tr><tr><td><code>Add(obj, action)</code></td><td>Track with a custom <code>TDisposeAction</code> called instead of <code>Free</code></td></tr><tr><td><code>Add(array)</code></td><td>Track multiple objects at once</td></tr><tr><td><code>Add(array, action)</code></td><td>Track multiple objects with a shared custom action</td></tr><tr><td><code>CollectGarbage</code></td><td>Force immediate disposal of all tracked objects (normally called automatically)</td></tr></tbody></table><blockquote><p><code>Add</code> accepts <code>TValue</code>, so you can pass any object directly — Delphi converts it implicitly. Duplicate registrations are silently ignored.</p></blockquote>`,24)])])}const E=i(n,[["render",l]]);export{c as __pageData,E as default};
